{% extends "base.html" %}

{% block title %}{{ app.name }} - POL Portal{% endblock %}

{% block content %}
<ul class="breadcrumb">
    <li><a href="{{ url_for('dashboard.index') }}">ダッシュボード</a></li>
    <li>{{ app.name }}</li>
</ul>

<div class="page-header">
    <h1><i class="bi bi-app"></i> {{ app.name }}</h1>
</div>

<!-- Basic Info -->
<div class="card-modern">
    <div class="card-modern-header">
        <i class="bi bi-info-circle"></i> 基本情報
    </div>
    <div class="card-modern-body">
        <dl>
            <dt>ID</dt>
            <dd>{{ app.id }}</dd>

            <dt>説明</dt>
            <dd>{{ app.description }}</dd>

            <dt>サービス名</dt>
            <dd><code>{{ app.service_name }}</code></dd>

            <dt>ポート</dt>
            <dd>{{ app.port }}</dd>

            <dt>ヘルスチェック</dt>
            <dd><code>http://localhost:{{ app.port }}{{ app.health_check_path }}</code></dd>

            <dt>自動再起動</dt>
            <dd>
                {% if app.auto_restart %}
                <span class="badge badge-success">有効</span>
                {% else %}
                <span class="badge badge-secondary">無効</span>
                {% endif %}
            </dd>
        </dl>
    </div>
</div>

<!-- Status -->
<div class="card-modern">
    <div class="card-modern-header">
        <i class="bi bi-activity"></i> 状態
    </div>
    <div class="card-modern-body">
        <p>
            状態: <strong id="app-status">--</strong>
        </p>
        <p>
            サービス: <span id="service-active">--</span>
        </p>
        <p>
            ヘルスチェック: <span id="health-check">--</span>
        </p>

        <div class="btn-group mt-2">
            <button id="btn-start" class="btn-outline" type="button"><i class="bi bi-play"></i> 起動</button>
            <button id="btn-stop" class="btn-outline" type="button"><i class="bi bi-stop"></i> 停止</button>
            <button id="btn-restart" class="btn-outline" type="button"><i class="bi bi-arrow-repeat"></i> 再起動</button>
            <button id="btn-refresh" class="btn-outline-secondary" type="button"><i class="bi bi-arrow-clockwise"></i> 更新</button>
        </div>
    </div>
</div>

{% if app.github_owner and app.github_repo %}
<!-- GitHub -->
<div class="card-modern">
    <div class="card-modern-header">
        <i class="bi bi-github"></i> GitHub
    </div>
    <div class="card-modern-body">
        <p>
            <i class="bi bi-link-45deg"></i> リポジトリ:
            <a href="https://github.com/{{ app.github_owner }}/{{ app.github_repo }}" target="_blank">
                {{ app.github_owner }}/{{ app.github_repo }}
            </a>
        </p>

        {% if current_user.is_admin %}
        <h3 class="mt-2">インストール管理</h3>
        <p>
            インストール状態:
            {% if app.installed %}
            <span class="badge badge-success">インストール済み</span>
            <small>({{ app.installed_version }})</small>
            {% else %}
            <span class="badge badge-secondary">未インストール</span>
            {% endif %}
        </p>

        <p id="update-status"></p>

        <div class="btn-group mt-2">
            {% if not app.installed %}
            <button id="btn-install" class="btn-primary-modern" type="button"><i class="bi bi-download"></i> インストール</button>
            {% else %}
            <button id="btn-check-update" class="btn-outline" type="button"><i class="bi bi-search"></i> アップデート確認</button>
            <button id="btn-update" class="btn-outline" type="button" disabled><i class="bi bi-cloud-download"></i> アップデート</button>
            <button id="btn-uninstall" class="btn-outline-danger" type="button"><i class="bi bi-trash"></i> アンインストール</button>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}

{% if current_user.is_admin %}
<!-- Scripts -->
<div class="card-modern">
    <div class="card-modern-header">
        <i class="bi bi-terminal"></i> スクリプト
    </div>
    <div class="card-modern-body">
        <div id="scripts-list">
            <p>読み込み中...</p>
        </div>

        <button id="btn-add-script" class="btn-outline mt-2" type="button">
            <i class="bi bi-plus-circle"></i> スクリプト登録
        </button>
    </div>
</div>

<!-- スクリプト登録ダイアログ -->
<dialog id="dialog-add-script">
    <article style="min-width: 400px;">
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('dialog-add-script').close()"></button>
            <h3>スクリプト登録</h3>
        </header>
        <form id="form-add-script">
            <label for="script-id">ID <small>(英数字・ハイフン)</small></label>
            <input type="text" id="script-id" name="id" required pattern="[a-zA-Z0-9_-]+" placeholder="setup">

            <label for="script-name">名前</label>
            <input type="text" id="script-name" name="name" required placeholder="初期セットアップ">

            <label for="script-desc">説明 <small>(任意)</small></label>
            <input type="text" id="script-desc" name="description" placeholder="アプリの初期設定を実行">

            <label for="script-path">スクリプトパス</label>
            <input type="text" id="script-path" name="script_path" required placeholder="scripts/setup.bat">

            <label for="script-mode">実行モード</label>
            <select id="script-mode" name="mode">
                <option value="sync">同期</option>
                <option value="async">非同期</option>
            </select>

            <label for="script-timeout">タイムアウト (秒)</label>
            <input type="number" id="script-timeout" name="timeout" value="60" min="1" max="3600">

            <footer>
                <button type="button" class="btn-outline" onclick="document.getElementById('dialog-add-script').close()">キャンセル</button>
                <button type="submit" class="btn-primary-modern">登録</button>
            </footer>
        </form>
    </article>
</dialog>

<!-- 実行結果ダイアログ -->
<dialog id="dialog-execution-result">
    <article style="min-width: 500px; max-width: 80vw;">
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('dialog-execution-result').close()"></button>
            <h3>実行結果</h3>
        </header>
        <div id="execution-result-content">
            <p>ステータス: <strong id="exec-status">--</strong></p>
            <p>終了コード: <span id="exec-exit-code">--</span></p>
            <h4>標準出力</h4>
            <pre id="exec-stdout" style="max-height: 300px; overflow: auto; background: var(--pico-code-background-color); padding: 1rem; font-size: 0.85rem;"></pre>
            <h4>標準エラー</h4>
            <pre id="exec-stderr" style="max-height: 200px; overflow: auto; background: var(--pico-code-background-color); padding: 1rem; font-size: 0.85rem;"></pre>
        </div>
        <footer>
            <button type="button" class="btn-outline" onclick="document.getElementById('dialog-execution-result').close()">閉じる</button>
        </footer>
    </article>
</dialog>

<!-- 実行履歴ダイアログ -->
<dialog id="dialog-executions">
    <article style="min-width: 600px; max-width: 80vw;">
        <header>
            <button aria-label="Close" rel="prev" onclick="document.getElementById('dialog-executions').close()"></button>
            <h3>実行履歴</h3>
        </header>
        <div id="executions-content">
            <p>読み込み中...</p>
        </div>
        <footer>
            <button type="button" class="btn-outline" onclick="document.getElementById('dialog-executions').close()">閉じる</button>
        </footer>
    </article>
</dialog>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var appId = '{{ app.id }}';

    function getStatusLabel(status) {
        var labels = {
            'running': '実行中',
            'stopped': '停止',
            'error': 'エラー',
            'unknown': '不明'
        };
        return labels[status] || status;
    }

    function loadStatus() {
        fetch('/apps/api/' + appId + '/status')
            .then(response => response.json())
            .then(data => {
                var statusEl = document.getElementById('app-status');
                statusEl.textContent = getStatusLabel(data.status);
                statusEl.className = 'status-' + data.status;

                document.getElementById('service-active').textContent =
                    data.service_active ? 'アクティブ' : '非アクティブ';

                if (data.health_check_ok === null) {
                    document.getElementById('health-check').textContent = '-';
                } else {
                    document.getElementById('health-check').textContent =
                        data.health_check_ok ? 'OK' : 'NG';
                }

                document.getElementById('btn-start').disabled = data.status === 'running';
                document.getElementById('btn-stop').disabled = data.status === 'stopped';
            })
            .catch(function(error) {
                console.error('状態の取得に失敗:', error);
            });
    }

    function doAction(action) {
        fetch('/apps/api/' + appId + '/' + action, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            if (data.success) {
                setTimeout(loadStatus, 1000);
            }
        })
        .catch(function(error) {
            console.error('操作に失敗:', error);
            alert('操作に失敗しました');
        });
    }

    loadStatus();

    document.getElementById('btn-start').addEventListener('click', function() { doAction('start'); });
    document.getElementById('btn-stop').addEventListener('click', function() { doAction('stop'); });
    document.getElementById('btn-restart').addEventListener('click', function() { doAction('restart'); });
    document.getElementById('btn-refresh').addEventListener('click', loadStatus);

    var isAdmin = {{ 'true' if current_user.is_admin else 'false' }};
    var isInstalled = {{ 'true' if app.installed else 'false' }};

    // --- スクリプト管理 (admin only) ---
    if (isAdmin) {
        function loadScripts() {
            fetch('/apps/api/' + appId + '/scripts')
                .then(function(r) { return r.json(); })
                .then(function(scripts) {
                    var container = document.getElementById('scripts-list');
                    if (!scripts.length) {
                        container.innerHTML = '<p>登録されたスクリプトはありません。</p>';
                        return;
                    }
                    var html = '<table role="grid"><thead><tr>' +
                        '<th>名前</th><th>モード</th><th>パス</th><th>操作</th>' +
                        '</tr></thead><tbody>';
                    scripts.forEach(function(s) {
                        var modeBadge = s.mode === 'async'
                            ? '<span class="badge badge-info">非同期</span>'
                            : '<span class="badge badge-secondary">同期</span>';
                        var enabledClass = s.enabled ? '' : ' style="opacity:0.5"';
                        html += '<tr' + enabledClass + '>';
                        html += '<td><strong>' + escapeHtml(s.name) + '</strong>';
                        if (s.description) html += '<br><small>' + escapeHtml(s.description) + '</small>';
                        html += '</td>';
                        html += '<td>' + modeBadge + '</td>';
                        html += '<td><code style="font-size:0.8rem">' + escapeHtml(s.script_path) + '</code></td>';
                        html += '<td>';
                        html += '<button class="btn-outline btn-sm" onclick="executeScript(\'' + s.id + '\')" ' + (s.enabled ? '' : 'disabled') + '><i class="bi bi-play"></i></button> ';
                        html += '<button class="btn-outline-secondary btn-sm" onclick="showExecutions(\'' + s.id + '\')"><i class="bi bi-clock-history"></i></button> ';
                        html += '<button class="btn-outline-danger btn-sm" onclick="deleteScript(\'' + s.id + '\')"><i class="bi bi-trash"></i></button>';
                        html += '</td></tr>';
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                })
                .catch(function(err) {
                    document.getElementById('scripts-list').innerHTML = '<p>読み込みに失敗しました。</p>';
                });
        }

        function escapeHtml(text) {
            var div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function executeScript(scriptId) {
            if (!confirm('スクリプトを実行しますか？')) return;

            fetch('/apps/api/' + appId + '/scripts/' + scriptId + '/execute', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.execution_id && data.message === '非同期実行を開始しました') {
                    alert('非同期実行を開始しました。履歴から結果を確認してください。');
                    pollExecution(data.execution_id);
                } else {
                    showExecutionResult(data);
                }
            })
            .catch(function(err) {
                alert('実行に失敗しました');
            });
        }
        window.executeScript = executeScript;

        function showExecutionResult(data) {
            var statusLabels = {
                'running': '実行中', 'completed': '完了', 'failed': '失敗', 'timeout': 'タイムアウト'
            };

            document.getElementById('exec-status').textContent = statusLabels[data.status] || (data.success ? '完了' : '失敗');
            document.getElementById('exec-exit-code').textContent = data.exit_code !== null && data.exit_code !== undefined ? data.exit_code : '--';
            document.getElementById('exec-stdout').textContent = data.stdout || '(なし)';
            document.getElementById('exec-stderr').textContent = data.stderr || '(なし)';
            document.getElementById('dialog-execution-result').showModal();
        }

        function pollExecution(executionId) {
            var interval = setInterval(function() {
                fetch('/apps/api/scripts/executions/' + executionId)
                    .then(function(r) { return r.json(); })
                    .then(function(data) {
                        if (data.status !== 'running') {
                            clearInterval(interval);
                            showExecutionResult(data);
                        }
                    })
                    .catch(function() { clearInterval(interval); });
            }, 2000);
        }

        function showExecutions(scriptId) {
            var container = document.getElementById('executions-content');
            container.innerHTML = '<p>読み込み中...</p>';
            document.getElementById('dialog-executions').showModal();

            fetch('/apps/api/' + appId + '/scripts/' + scriptId + '/executions')
                .then(function(r) { return r.json(); })
                .then(function(executions) {
                    if (!executions.length) {
                        container.innerHTML = '<p>実行履歴がありません。</p>';
                        return;
                    }
                    var statusLabels = {
                        'running': '実行中', 'completed': '完了', 'failed': '失敗', 'timeout': 'タイムアウト'
                    };
                    var html = '<table role="grid"><thead><tr>' +
                        '<th>ID</th><th>ステータス</th><th>終了コード</th><th>実行者</th><th>開始</th><th>操作</th>' +
                        '</tr></thead><tbody>';
                    executions.forEach(function(e) {
                        html += '<tr>';
                        html += '<td>' + e.id + '</td>';
                        html += '<td>' + (statusLabels[e.status] || e.status) + '</td>';
                        html += '<td>' + (e.exit_code !== null ? e.exit_code : '--') + '</td>';
                        html += '<td>' + escapeHtml(e.executed_by) + '</td>';
                        html += '<td>' + (e.started_at ? new Date(e.started_at).toLocaleString() : '--') + '</td>';
                        html += '<td><button class="btn-outline btn-sm" onclick="viewExecution(' + e.id + ')"><i class="bi bi-eye"></i></button></td>';
                        html += '</tr>';
                    });
                    html += '</tbody></table>';
                    container.innerHTML = html;
                })
                .catch(function() {
                    container.innerHTML = '<p>読み込みに失敗しました。</p>';
                });
        }
        window.showExecutions = showExecutions;

        function viewExecution(executionId) {
            fetch('/apps/api/scripts/executions/' + executionId)
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    document.getElementById('dialog-executions').close();
                    showExecutionResult(data);
                })
                .catch(function() { alert('取得に失敗しました'); });
        }
        window.viewExecution = viewExecution;

        function deleteScript(scriptId) {
            if (!confirm('このスクリプトを削除しますか？')) return;

            fetch('/apps/api/' + appId + '/scripts/' + scriptId, { method: 'DELETE' })
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (data.success) loadScripts();
                    else alert(data.message);
                })
                .catch(function() { alert('削除に失敗しました'); });
        }
        window.deleteScript = deleteScript;

        document.getElementById('btn-add-script').addEventListener('click', function() {
            document.getElementById('form-add-script').reset();
            document.getElementById('dialog-add-script').showModal();
        });

        document.getElementById('form-add-script').addEventListener('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);
            var body = {};
            formData.forEach(function(val, key) { body[key] = val; });
            body.timeout = parseInt(body.timeout) || 60;

            fetch('/apps/api/' + appId + '/scripts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            })
            .then(function(r) { return r.json(); })
            .then(function(data) {
                if (data.success) {
                    document.getElementById('dialog-add-script').close();
                    loadScripts();
                } else {
                    alert(data.message);
                }
            })
            .catch(function() { alert('登録に失敗しました'); });
        });

        loadScripts();
    }

    // --- GitHub / インストール管理 ---
    if (isAdmin) {
        if (!isInstalled) {
            document.getElementById('btn-install').addEventListener('click', function() {
                if (!confirm('このアプリをインストールしますか？')) return;

                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> インストール中...';

                fetch('/apps/api/' + appId + '/install', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        if (data.success) {
                            location.reload();
                        } else {
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-download"></i> インストール';
                        }
                    })
                    .catch(function(error) {
                        alert('インストールに失敗しました');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-download"></i> インストール';
                    }.bind(this));
            });
        } else {
            document.getElementById('btn-check-update').addEventListener('click', function() {
                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> 確認中...';

                fetch('/apps/api/' + appId + '/check-update')
                    .then(response => response.json())
                    .then(data => {
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-search"></i> アップデート確認';

                        var statusEl = document.getElementById('update-status');
                        if (data.error) {
                            statusEl.textContent = 'エラー: ' + data.error;
                        } else if (data.has_update) {
                            statusEl.innerHTML = '<span class="badge badge-success">新バージョンあり: ' + data.latest_version + '</span>';
                            document.getElementById('btn-update').disabled = false;
                        } else {
                            statusEl.textContent = '最新バージョンです';
                        }
                    })
                    .catch(function(error) {
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-search"></i> アップデート確認';
                        alert('確認に失敗しました');
                    }.bind(this));
            });

            document.getElementById('btn-update').addEventListener('click', function() {
                if (!confirm('アプリをアップデートしますか？\nサービスは一時停止されます。')) return;

                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> アップデート中...';

                fetch('/apps/api/' + appId + '/update', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        if (data.success) {
                            location.reload();
                        } else {
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-cloud-download"></i> アップデート';
                        }
                    })
                    .catch(function(error) {
                        alert('アップデートに失敗しました');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-cloud-download"></i> アップデート';
                    }.bind(this));
            });

            document.getElementById('btn-uninstall').addEventListener('click', function() {
                if (!confirm('このアプリをアンインストールしますか？\nこの操作は取り消せません。')) return;

                this.disabled = true;
                this.innerHTML = '<i class="bi bi-hourglass-split"></i> アンインストール中...';

                fetch('/apps/api/' + appId + '/uninstall', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        alert(data.message);
                        if (data.success) {
                            location.reload();
                        } else {
                            this.disabled = false;
                            this.innerHTML = '<i class="bi bi-trash"></i> アンインストール';
                        }
                    })
                    .catch(function(error) {
                        alert('アンインストールに失敗しました');
                        this.disabled = false;
                        this.innerHTML = '<i class="bi bi-trash"></i> アンインストール';
                    }.bind(this));
            });
        }
    }
});
</script>
{% endblock %}

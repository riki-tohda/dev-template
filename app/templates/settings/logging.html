{% extends "base.html" %}

{% block title %}ログ設定 - POL Portal{% endblock %}

{% block content %}
<ul class="breadcrumb">
    <li><a href="{{ url_for('settings.index') }}">設定</a></li>
    <li>ログ設定</li>
</ul>

<div class="page-header">
    <h1><i class="bi bi-journal-text"></i> ログ設定</h1>
</div>

<div class="setting-section">
    <div class="setting-section-header">
        <i class="bi bi-calendar-range"></i>
        <span>保持期間設定</span>
    </div>
    <div class="setting-section-body">
        <form method="post">
            <label for="retention_days">ログ保持期間（日）</label>
            <input type="number" id="retention_days" name="retention_days"
                   value="{{ settings.retention_days }}"
                   min="1" max="365" required>
            <small>この期間を過ぎたログはアーカイブされます（1-365日）</small>

            <label for="archive_retention_days">アーカイブ保持期間（日）</label>
            <input type="number" id="archive_retention_days" name="archive_retention_days"
                   value="{{ settings.archive_retention_days }}"
                   min="1" max="365" required>
            <small>この期間を過ぎたアーカイブは削除されます（1-365日）</small>

            <label for="max_size_mb">1ファイル最大サイズ（MB）</label>
            <input type="number" id="max_size_mb" name="max_size_mb"
                   value="{{ settings.max_size_mb }}"
                   min="1" max="100" required>
            <small>ログファイル1つあたりの最大サイズ（1-100MB）</small>

            <label for="max_folder_size_mb">最大フォルダサイズ（MB）</label>
            <input type="number" id="max_folder_size_mb" name="max_folder_size_mb"
                   value="{{ settings.max_folder_size_mb }}"
                   min="10" max="10000" required>
            <small>ログフォルダ全体の最大サイズ（10-10000MB）</small>

            <label for="backup_count">バックアップ数</label>
            <input type="number" id="backup_count" name="backup_count"
                   value="{{ settings.backup_count }}"
                   min="1" max="10" required>
            <small>ログファイルのローテーション保持数（1-10）</small>

            <label for="maintenance_interval_hours">自動メンテナンス間隔（時間）</label>
            <input type="number" id="maintenance_interval_hours" name="maintenance_interval_hours"
                   value="{{ settings.maintenance_interval_hours }}"
                   min="0" max="168" required>
            <small>自動クリーンアップの実行間隔（0で無効、1-168時間）</small>

            <button type="submit"><i class="bi bi-save"></i> 保存</button>
        </form>
    </div>
</div>

<div class="setting-section">
    <div class="setting-section-header">
        <i class="bi bi-bar-chart"></i>
        <span>ログ統計情報</span>
    </div>
    <div class="setting-section-body">
        <table id="log-stats-table">
            <tbody>
                <tr>
                    <th>合計サイズ</th>
                    <td id="stat-total-size">読み込み中...</td>
                </tr>
                <tr>
                    <th>使用率</th>
                    <td id="stat-usage-percent">読み込み中...</td>
                </tr>
                <tr>
                    <th>日別ディレクトリ数</th>
                    <td id="stat-daily-dirs">読み込み中...</td>
                </tr>
                <tr>
                    <th>アーカイブ数</th>
                    <td id="stat-archive-count">読み込み中...</td>
                </tr>
                <tr>
                    <th>自動メンテナンス</th>
                    <td id="stat-scheduler">読み込み中...</td>
                </tr>
                <tr>
                    <th>次回実行予定</th>
                    <td id="stat-next-run">読み込み中...</td>
                </tr>
            </tbody>
        </table>
        <button type="button" id="btn-maintenance" class="btn-outline" style="margin-top: 1rem;">
            <i class="bi bi-wrench"></i> メンテナンス実行
        </button>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    fetch('{{ url_for("settings.logging_stats") }}')
        .then(response => response.json())
        .then(data => {
            document.getElementById('stat-total-size').textContent = data.total_size_mb + ' MB';
            document.getElementById('stat-usage-percent').textContent = data.usage_percent + '% (' + data.max_size_mb + ' MB中)';
            document.getElementById('stat-daily-dirs').textContent = data.daily_directories;
            document.getElementById('stat-archive-count').textContent = data.archive_count;
            if (data.scheduler_active) {
                document.getElementById('stat-scheduler').textContent = '有効（' + data.scheduler_interval_hours + '時間間隔）';
                document.getElementById('stat-next-run').textContent = data.next_maintenance || '-';
            } else {
                document.getElementById('stat-scheduler').textContent = '無効';
                document.getElementById('stat-next-run').textContent = '-';
            }
        })
        .catch(() => {
            document.getElementById('stat-total-size').textContent = '取得エラー';
        });

    document.getElementById('btn-maintenance').addEventListener('click', function() {
        if (!confirm('ログメンテナンスを実行しますか？')) return;
        fetch('{{ url_for("settings.logging_maintenance") }}', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                alert('メンテナンス完了\nアーカイブ: ' + data.archived + '件\n削除(ログ): ' + data.deleted_logs + '件\n削除(アーカイブ): ' + data.deleted_archives + '件');
                location.reload();
            })
            .catch(() => {
                alert('メンテナンスの実行に失敗しました');
            });
    });
});
</script>
{% endblock %}

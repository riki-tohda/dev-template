# ログ設計仕様書

## 概要

本システムのログ出力・管理方針を定義する。

## 基本方針

| 項目 | 設定 |
|------|------|
| ライブラリ | Python標準 `logging` |
| 出力先 | コンソール（stderr）+ ファイル |
| フォーマット | テキスト形式 |
| 文字コード | UTF-8 |
| 格納先 | `logs/`（プロジェクト相対） |

## ディレクトリ構成

```
logs/
├── 2025-01-20/           # 日付ディレクトリ（YYYY-MM-DD）
│   ├── app.log           # アプリケーションログ
│   ├── app.log.1         # サイズ超過時の世代ファイル
│   ├── resource.log      # リソース監視ログ
│   └── auth.log          # 認証・セキュリティログ
├── 2025-01-21/
│   ├── app.log
│   ├── resource.log
│   └── auth.log
└── archive/              # アーカイブ（圧縮済み）
    ├── 2025-01-12.tar.gz
    └── 2025-01-13.tar.gz
```

## ログ種別

### app（アプリケーションログ）

| 項目 | 内容 |
|------|------|
| ファイル名 | `app.log` |
| ロガー名 | `app`, `app.*` |
| 用途 | アプリ起動/終了、一般的なエラー、処理状況 |

**出力例：**
- アプリケーション起動/終了
- リクエスト処理エラー
- 外部サービス接続エラー
- 設定読み込み

### resource（リソース監視ログ）

| 項目 | 内容 |
|------|------|
| ファイル名 | `resource.log` |
| ロガー名 | `resource` |
| 用途 | リソース監視結果、閾値超過警告 |

**出力例：**
- リソース使用率の定期記録
- CPU/メモリ/ディスク閾値超過警告
- 管理対象アプリの状態変化

### auth（認証・セキュリティログ）

| 項目 | 内容 |
|------|------|
| ファイル名 | `auth.log` |
| ロガー名 | `auth` |
| 用途 | 認証イベント、セキュリティ関連 |

**出力例：**
- ログイン成功/失敗
- ログアウト
- セッション期限切れ
- 権限エラー（403）
- 不正アクセス試行

## ログレベル

| レベル | 用途 | 例 |
|--------|------|-----|
| DEBUG | 開発時のデバッグ情報 | リクエストパラメータ、内部状態 |
| INFO | 通常の動作記録 | アプリ起動、ユーザーログイン |
| WARNING | 注意が必要な状況 | 閾値超過、リトライ発生 |
| ERROR | エラー（処理継続可能） | API呼び出し失敗、ファイル読み込み失敗 |
| CRITICAL | 致命的エラー（処理継続不可） | 必須設定の欠落、起動失敗 |

### 環境別デフォルトレベル

| 環境 | レベル |
|------|--------|
| 開発 | DEBUG |
| 本番 | INFO |

## ログフォーマット

### 形式

```
{timestamp} [{level}] {logger}: {message}
```

### 例

```
2025-01-20 10:00:00.123 [INFO] app: アプリケーションを起動しました port=8000
2025-01-20 10:00:05.456 [INFO] auth: ユーザーがログインしました user=admin ip=192.168.1.100
2025-01-20 10:01:00.000 [WARNING] resource: CPU使用率が閾値を超えました usage=85% threshold=80%
2025-01-20 10:05:00.789 [ERROR] app: サービス起動に失敗しました service=pol-label-printer error=Connection refused
```

### フォーマット仕様

| 要素 | 形式 | 説明 |
|------|------|------|
| timestamp | `%Y-%m-%d %H:%M:%S.%f` | ミリ秒まで（小数点以下3桁） |
| level | 大文字 | INFO, DEBUG, WARNING, ERROR, CRITICAL |
| logger | ロガー名 | `app`, `resource`, `auth` |
| message | 自由形式 | key=value形式で構造化推奨 |

## ファイル管理

### ファイル命名規則

| 種類 | パターン | 例 |
|------|----------|-----|
| 日付ディレクトリ | `YYYY-MM-DD/` | `2025-01-20/` |
| ログファイル | `{type}.log` | `app.log`, `resource.log`, `auth.log` |
| サイズローテーション | `{type}.log.{n}` | `app.log.1`, `app.log.2` |
| アーカイブ | `YYYY-MM-DD.tar.gz` | `2025-01-12.tar.gz` |

### ローテーション

#### 日付ローテーション

| 項目 | 仕様 |
|------|------|
| タイミング | 日付が変わった時点（最初の書き込み時） |
| 動作 | 新しい日付ディレクトリを作成し、そこに出力 |

#### サイズローテーション

| 項目 | 仕様 |
|------|------|
| 条件 | 1ファイルが上限サイズを超過 |
| 動作 | 世代番号を付与（`.1`, `.2`, ...） |
| デフォルト上限 | 10MB |
| デフォルト世代数 | 3 |

### 保持期間

| 種類 | 期間 | 動作 |
|------|------|------|
| ログ期間 | デフォルト7日 | 期間を超えた日付ディレクトリをアーカイブへ移動・圧縮 |
| アーカイブ期間 | デフォルト30日 | 期間を超えたアーカイブを削除 |

### フォルダサイズ上限

| 項目 | 仕様 |
|------|------|
| 対象 | `logs/` フォルダ全体（アーカイブ含む） |
| デフォルト上限 | 500MB |
| 動作 | 上限を超えた場合、古い日付から削除 |
| 優先順位 | アーカイブ → 古いログの順に削除 |

### 管理タイミング

| タイミング | 実行内容 |
|------------|----------|
| アプリ起動時 | ローテーション、アーカイブ、削除をすべてチェック |
| 日次 | 同上（バックグラウンドで実行） |

## 設定

### config.yaml

```yaml
logging:
  # ログレベル: DEBUG / INFO / WARNING / ERROR / CRITICAL
  level: INFO

  # ログディレクトリ
  # - 相対パス: プロジェクトルートからの相対（例: "logs"）
  # - 絶対パス: そのまま使用（例: "/var/log/pol-lab"）
  directory: logs

  # コンソール出力
  console:
    enabled: true

  # サイズローテーション（1ファイルあたり）
  max_size_mb: 10           # MB単位
  backup_count: 3           # 世代数（.1, .2, .3）

  # 保持期間
  retention_days: 7         # ログ保持日数（超過でアーカイブへ）

  # アーカイブ設定
  archive:
    enabled: true
    directory: archive      # アーカイブディレクトリ（ログディレクトリからの相対）
    retention_days: 30      # アーカイブ保持日数（超過で削除）

  # フォルダサイズ上限
  max_folder_size_mb: 500   # 超過時は古いファイルから削除
```

### 設定項目一覧

| 項目 | デフォルト | 説明 |
|------|-----------|------|
| `level` | INFO | ログ出力レベル |
| `directory` | logs | ログディレクトリ（相対/絶対パス） |
| `console.enabled` | true | コンソール出力の有効/無効 |
| `max_size_mb` | 10 | 1ファイルあたりの最大サイズ（MB） |
| `backup_count` | 3 | サイズローテーション時の世代数 |
| `retention_days` | 7 | ログ保持日数 |
| `archive.enabled` | true | アーカイブの有効/無効 |
| `archive.directory` | archive | アーカイブディレクトリ |
| `archive.retention_days` | 30 | アーカイブ保持日数 |
| `max_folder_size_mb` | 500 | フォルダサイズ上限（MB） |

## 実装方針

### モジュール構成

```
app/
└── services/
    └── log_manager.py    # ログ管理サービス
```

### 主要クラス/関数

| 名前 | 責務 |
|------|------|
| `setup_logging()` | ロガーの初期化・設定 |
| `get_logger(name)` | 種別に応じたロガー取得 |
| `LogManager` | ローテーション・アーカイブ・削除の管理 |
| `LogManager.rotate()` | 日付ディレクトリ作成・サイズローテーション |
| `LogManager.archive()` | 古いログの圧縮・移動 |
| `LogManager.cleanup()` | 期限切れファイルの削除 |
| `LogManager.enforce_size_limit()` | フォルダサイズ上限の適用 |

### ロガー取得方法

```python
from app.services.log_manager import get_logger

# アプリケーションログ
app_logger = get_logger("app")
app_logger.info("アプリケーションを起動しました port=%d", port)

# リソース監視ログ
resource_logger = get_logger("resource")
resource_logger.warning("CPU使用率が閾値を超えました usage=%d%% threshold=%d%%", usage, threshold)

# 認証ログ
auth_logger = get_logger("auth")
auth_logger.info("ユーザーがログインしました user=%s ip=%s", username, ip)
```

### 依存ライブラリ

標準ライブラリのみ使用（外部依存なし）:
- `logging`
- `tarfile`
- `shutil`
- `pathlib`

## ログ出力ガイドライン

### 推奨フォーマット

```python
# key=value形式で構造化
logger.info("ユーザーがログインしました user=%s ip=%s", username, ip_address)

# エラー時は例外情報を含める
logger.error("ファイル読み込みに失敗しました path=%s", file_path, exc_info=True)
```

### 各ログへの出力基準

| イベント | 出力先 |
|----------|--------|
| アプリ起動/終了 | app |
| 設定読み込み | app |
| リクエスト処理エラー | app |
| 外部サービスエラー | app |
| リソース使用率記録 | resource |
| 閾値超過警告 | resource |
| 管理アプリ状態変化 | resource |
| ログイン/ログアウト | auth |
| 認証失敗 | auth |
| 権限エラー | auth |

### 禁止事項

- パスワード、トークン等の機密情報をログに出力しない
- 個人情報（氏名、メールアドレス等）は必要最小限に

## 改訂履歴

| 日付 | 版 | 内容 |
|------|-----|------|
| 2025-01-20 | 1.0 | 初版作成 |
| 2025-01-20 | 1.1 | 日付ディレクトリ構成に変更、ログ種別追加（resource, auth） |

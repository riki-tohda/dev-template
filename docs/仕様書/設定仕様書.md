# 設定仕様書

## 1. 概要

### 1.1 目的
本書は、POL統合ポータル・リソース管理システム（pol-lab）の設定管理方式について定義する。

### 1.2 設定管理方針

| 方針 | 内容 |
|------|------|
| 初期設定 | YAML設定ファイルで定義 |
| 運用時の設定変更 | Web UIからSQLiteに保存 |
| 認証方式 | ユーザーID + パスワード認証（権限分け） |
| 複数端末展開 | 初期設定ファイルをコピーして展開 |

### 1.4 権限モデル

| 権限 | 説明 |
|------|------|
| admin | 管理者。全機能にアクセス可能 |
| user | 一般ユーザー。設定変更不可 |

#### 権限別アクセス制御

| 機能 | admin | user |
|------|-------|------|
| ダッシュボード閲覧 | ○ | ○ |
| リソースモニタ閲覧 | ○ | ○ |
| アプリ状態確認 | ○ | ○ |
| アプリ起動・停止・再起動 | ○ | ○ |
| アプリダウンロード実行 | ○ | × |
| システム設定変更 | ○ | × |
| アプリケーション設定変更 | ○ | × |
| ユーザー管理 | ○ | × |
| 自分のパスワード変更 | ○ | ○ |

### 1.3 設定管理フロー

```
┌─────────────────────────────────────────────────────────────┐
│                      初回起動時                              │
├─────────────────────────────────────────────────────────────┤
│  config.yaml  ──┐                                           │
│                 ├──→  settings.db（SQLite）を生成           │
│  apps.yaml    ──┘                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      通常運用時                              │
├─────────────────────────────────────────────────────────────┤
│  Web UI  ←──→  settings.db（読み書き）                      │
└─────────────────────────────────────────────────────────────┘
```

---

## 2. ファイル構成

```
config/
├── config.yaml      # システム初期設定
├── apps.yaml        # アプリケーション定義（初期値）
└── settings.db      # 運用時の設定保存（自動生成）

/etc/pol-lab/
└── env              # 環境変数（機密情報）
```

---

## 3. 環境変数

機密情報は環境変数で管理し、設定ファイルには含めない。

### 3.1 環境変数一覧

| 変数名 | 必須 | 説明 |
|--------|------|------|
| POL_GITHUB_TOKEN | Yes | GitHub Personal Access Token（private/internalリポジトリアクセス用） |
| POL_SECRET_KEY | No | セッション暗号化キー（未指定時は自動生成してDBに保存） |

### 3.2 設定方法

#### systemd EnvironmentFile（推奨）

```bash
# /etc/pol-lab/env
POL_GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

```ini
# /etc/systemd/system/pol-lab.service
[Service]
EnvironmentFile=/etc/pol-lab/env
ExecStart=/opt/pol-lab/venv/bin/python -m flask run
```

#### 直接指定

```ini
# /etc/systemd/system/pol-lab.service
[Service]
Environment="POL_GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx"
```

### 3.3 セキュリティ考慮事項

- `/etc/pol-lab/env` のパーミッションは `600`（所有者のみ読み書き可）
- 設定ファイル（config.yaml, apps.yaml）には機密情報を含めない
- 端末展開時に env ファイルはコピーしない（端末ごとに個別設定）

---

## 4. 初期設定ファイル仕様

### 4.1 システム設定（config.yaml）

```yaml
# =====================================================
# POL統合ポータル システム設定
# =====================================================

# ----- サーバー設定 -----
server:
  host: "0.0.0.0"           # バインドアドレス
  port: 8000                # ポート番号
  debug: false              # デバッグモード（本番はfalse）

# ----- セッション設定 -----
session:
  lifetime_hours: 24        # セッション有効時間（時間）

# ----- 認証設定 -----
auth:
  # 初期ユーザー（初回起動時にDBに登録）
  # パスワードは平文で記載し、初回起動時にbcryptハッシュ化
  initial_users:
    - username: "admin"
      password: "admin"
      role: "admin"         # admin または user
    - username: "user"
      password: "user"
      role: "user"

# ----- リソースモニタ設定 -----
resource_monitor:
  # 監視対象ディスクパス
  disk_paths:
    - "/"

  # 警告閾値（%）
  warning_thresholds:
    cpu_percent: 80
    memory_percent: 80
    disk_percent: 90

# ----- アプリインストール設定 -----
app_install:
  # ローカルインストール先ディレクトリ
  install_dir: "/opt/pol-apps"
  # ※ GitHub tokenは環境変数で管理（後述）

# ----- ログ設定 -----
logging:
  level: "INFO"             # DEBUG, INFO, WARNING, ERROR
  file: "logs/portal.log"   # ログファイルパス
  max_size_mb: 10           # ローテーションサイズ
  backup_count: 3           # 保持世代数
```

#### 設定項目詳細

| カテゴリ | 項目 | 型 | 必須 | デフォルト | 説明 |
|----------|------|-----|------|------------|------|
| server | host | string | No | "0.0.0.0" | サーバーバインドアドレス |
| server | port | int | No | 8000 | サーバーポート番号 |
| server | debug | bool | No | false | デバッグモード |
| session | lifetime_hours | int | No | 24 | セッション有効時間（時間） |
| auth | initial_users | list | Yes | - | 初期ユーザーリスト |
| auth | initial_users[].username | string | Yes | - | ユーザーID |
| auth | initial_users[].password | string | Yes | - | 初期パスワード（平文） |
| auth | initial_users[].role | string | Yes | - | 権限（admin/user） |
| resource_monitor | disk_paths | list | No | ["/"] | 監視対象ディスクパス |
| resource_monitor | warning_thresholds.cpu_percent | int | No | 80 | CPU警告閾値 |
| resource_monitor | warning_thresholds.memory_percent | int | No | 80 | メモリ警告閾値 |
| resource_monitor | warning_thresholds.disk_percent | int | No | 90 | ディスク警告閾値 |
| app_install | install_dir | string | No | "/opt/pol-apps" | アプリインストール先 |
| logging | level | string | No | "INFO" | ログレベル |
| logging | file | string | No | "logs/portal.log" | ログファイルパス |
| logging | max_size_mb | int | No | 10 | ログローテーションサイズ |
| logging | backup_count | int | No | 3 | ログ保持世代数 |

---

### 4.2 アプリケーションカタログ（apps.yaml）

apps.yaml は利用可能なアプリケーションのカタログ（マスター定義）です。
実際のインストール状態は端末ごとにDBで管理されます。

```yaml
# =====================================================
# アプリケーションカタログ（利用可能なアプリ一覧）
# =====================================================

applications:
  - id: "label-printer"
    name: "ラベル印刷指示アプリ"
    description: "医療ラベルの印刷指示を管理"

    # GitHub設定
    github_owner: "Neopolalis"
    github_repo: "pol-label-printer"

    # ローカル設定（インストール後に使用）
    service_name: "pol-label-printer"
    port: 8001
    health_check_path: "/health"
    auto_restart: true

  - id: "file-transfer"
    name: "ファイル転送アプリ"
    description: "ファイルの転送処理を管理"
    github_owner: "Neopolalis"
    github_repo: "pol-file-transfer"
    service_name: "pol-file-transfer"
    port: 8002
    health_check_path: "/health"
    auto_restart: true

  - id: "file-sync"
    name: "ファイル送受信アプリ"
    description: "ファイルの送受信を管理"
    github_owner: "Neopolalis"
    github_repo: "pol-file-sync"
    service_name: "pol-file-sync"
    port: 8003
    health_check_path: "/health"
    auto_restart: true

  - id: "me-integration"
    name: "ME連携アプリ"
    description: "MEシステムとの連携を管理"
    github_owner: "Neopolalis"
    github_repo: "pol-me-integration"
    service_name: "pol-me-integration"
    port: 8004
    health_check_path: "/health"
    auto_restart: true
```

#### アプリケーション定義項目

| 項目 | 型 | 必須 | 説明 |
|------|-----|------|------|
| id | string | Yes | アプリケーション識別子（英数字・ハイフン） |
| name | string | Yes | 表示名 |
| description | string | No | 説明文 |
| github_owner | string | Yes | GitHubオーナー名（組織名またはユーザー名） |
| github_repo | string | Yes | GitHubリポジトリ名 |
| service_name | string | Yes | systemdサービス名 |
| port | int | Yes | 使用ポート番号 |
| health_check_path | string | No | ヘルスチェックエンドポイント |
| auto_restart | bool | No | 障害時自動再起動（デフォルト: false） |

---

## 5. データベース仕様（settings.db）

### 5.1 概要

| 項目 | 内容 |
|------|------|
| DBMS | SQLite 3 |
| ファイルパス | config/settings.db |
| 文字コード | UTF-8 |

### 5.2 テーブル定義

#### users テーブル（ユーザー管理）

```sql
CREATE TABLE users (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    username        TEXT UNIQUE NOT NULL,
    password_hash   TEXT NOT NULL,
    role            TEXT NOT NULL DEFAULT 'user',
    enabled         INTEGER DEFAULT 1,
    created_at      DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at      DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

| カラム | 型 | 説明 |
|--------|-----|------|
| id | INTEGER | ユーザーID（自動採番） |
| username | TEXT | ユーザー名（ユニーク） |
| password_hash | TEXT | bcryptハッシュ化パスワード |
| role | TEXT | 権限（admin/user） |
| enabled | INTEGER | 有効/無効（0: 無効, 1: 有効） |
| created_at | DATETIME | 作成日時 |
| updated_at | DATETIME | 更新日時 |

#### settings テーブル（システム設定）

```sql
CREATE TABLE settings (
    key         TEXT PRIMARY KEY,
    value       TEXT NOT NULL,
    category    TEXT NOT NULL,
    updated_at  DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

| カラム | 型 | 説明 |
|--------|-----|------|
| key | TEXT | 設定キー（例: "server.port"） |
| value | TEXT | 設定値（JSON形式で保存） |
| category | TEXT | カテゴリ（server, session, auth, resource_monitor, app_download, logging） |
| updated_at | DATETIME | 更新日時 |

#### applications テーブル（アプリケーション管理）

```sql
CREATE TABLE applications (
    id                  TEXT PRIMARY KEY,
    name                TEXT NOT NULL,
    description         TEXT,

    -- GitHub設定
    github_owner        TEXT NOT NULL,
    github_repo         TEXT NOT NULL,

    -- ローカル設定
    service_name        TEXT NOT NULL,
    port                INTEGER NOT NULL,
    health_check_path   TEXT,
    auto_restart        INTEGER DEFAULT 0,

    -- インストール状態
    installed           INTEGER DEFAULT 0,
    installed_version   TEXT,
    installed_at        DATETIME,

    -- 管理用
    sort_order          INTEGER DEFAULT 0,
    updated_at          DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

| カラム | 型 | 説明 |
|--------|-----|------|
| id | TEXT | アプリケーション識別子 |
| name | TEXT | 表示名 |
| description | TEXT | 説明文 |
| github_owner | TEXT | GitHubオーナー名 |
| github_repo | TEXT | GitHubリポジトリ名 |
| service_name | TEXT | systemdサービス名 |
| port | INTEGER | 使用ポート番号 |
| health_check_path | TEXT | ヘルスチェックエンドポイント |
| auto_restart | INTEGER | 自動再起動（0: 無効, 1: 有効） |
| installed | INTEGER | インストール状態（0: 未, 1: 済） |
| installed_version | TEXT | インストール済バージョン（タグ名） |
| installed_at | DATETIME | インストール日時 |
| sort_order | INTEGER | 表示順序 |
| updated_at | DATETIME | 更新日時 |

---

## 6. Web UI設定画面仕様

### 6.1 設定画面構成

| 画面 | URL | 必要権限 | 内容 |
|------|-----|----------|------|
| 設定トップ | /settings | admin | 設定カテゴリ一覧 |
| サーバー設定 | /settings/server | admin | ポート番号等 |
| セッション設定 | /settings/session | admin | セッション有効時間 |
| ユーザー管理 | /settings/users | admin | ユーザー追加・編集・削除 |
| リソース監視設定 | /settings/resource | admin | 警告閾値 |
| アプリインストール設定 | /settings/apps | admin | インストール先等 |
| パスワード変更 | /profile/password | 全員 | 自分のパスワード変更 |

※ GitHub tokenは環境変数で管理するため、Web UIからは変更不可

### 6.2 変更可能項目一覧

| カテゴリ | 項目 | 変更可否 | 必要権限 |
|----------|------|----------|----------|
| サーバー | host | 不可（セキュリティ上） | - |
| サーバー | port | 可（要再起動） | admin |
| サーバー | debug | 不可（セキュリティ上） | - |
| セッション | lifetime_hours | 可 | admin |
| ユーザー | 追加・編集・削除 | 可 | admin |
| ユーザー | 自分のパスワード | 可（現パスワード入力必須） | 全員 |
| リソース監視 | disk_paths | 可 | admin |
| リソース監視 | warning_thresholds | 可 | admin |
| アプリインストール | install_dir | 可 | admin |
| ログ | level | 可 | admin |
| ログ | file | 不可 | - |
| ログ | max_size_mb | 可 | admin |
| ログ | backup_count | 可 | admin |

### 6.3 設定変更時の動作

| 設定種別 | 反映タイミング |
|----------|----------------|
| セッション設定 | 即座に反映 |
| ユーザー追加・編集・削除 | 即座に反映 |
| パスワード変更 | 即座に反映 |
| リソース監視閾値 | 即座に反映 |
| アプリインストール設定 | 即座に反映 |
| ログレベル | 即座に反映 |
| サーバーポート | 再起動後に反映 |

---

## 7. アプリインストール機能

### 7.1 概要

ポータルからGitHub Releasesを経由して管理対象アプリをインストールする機能。

### 7.2 インストールフロー

```
1. Web UI「アプリ管理」画面でアプリ一覧を表示
   （apps.yaml のカタログ + installed状態）
   ↓
2. 未インストールアプリの「インストール」ボタン押下
   ↓
3. GitHub API で最新Releaseを取得
   GET https://api.github.com/repos/{owner}/{repo}/releases/latest
   Authorization: Bearer {token}
   ↓
4. Release assetをダウンロード（zipファイル）
   ↓
5. install_dir/{app_id}/ に展開
   例: /opt/pol-apps/label-printer/
   ↓
6. systemdサービスを登録・起動（必要な場合）
   ↓
7. DBの installed=1, installed_version, installed_at を更新
```

### 7.3 アップデートフロー

```
1. 「アップデート確認」ボタン押下
   ↓
2. GitHub API で最新Releaseを取得
   ↓
3. installed_version と比較
   ↓
4. 新バージョンがあれば「アップデート」ボタンを表示
   ↓
5. アップデート実行（サービス停止 → 展開 → サービス起動）
```

### 7.4 アンインストールフロー

```
1. 「アンインストール」ボタン押下
   ↓
2. 確認ダイアログ表示
   ↓
3. systemdサービス停止・削除
   ↓
4. install_dir/{app_id}/ を削除
   ↓
5. DBの installed=0, installed_version=NULL を更新
```

### 7.5 画面仕様

#### アプリ一覧画面（/apps）

| 表示項目 | 説明 |
|----------|------|
| アプリ名 | name |
| 説明 | description |
| 状態 | 未インストール / 停止中 / 実行中 / エラー |
| インストール済バージョン | installed_version |
| 最新バージョン | GitHub APIから取得（キャッシュ） |
| 操作ボタン | インストール / 起動 / 停止 / 再起動 / アップデート / アンインストール |

#### 状態判定ロジック

| installed | サービス状態 | 表示 |
|-----------|--------------|------|
| 0 | - | 未インストール |
| 1 | active | 実行中 |
| 1 | inactive | 停止中 |
| 1 | failed | エラー |

---

## 8. 初期化・リセット

### 8.1 初回起動時の初期化

```
1. config/settings.db が存在しない場合
   ↓
2. config.yaml を読み込み
   ↓
3. apps.yaml を読み込み
   ↓
4. settings.db を作成（テーブル: users, settings, applications）
   ↓
5. 初期ユーザーを登録（パスワードをbcryptハッシュ化）
   ↓
6. その他の設定値をDBに保存
```

### 8.2 設定リセット手順

設定を初期状態に戻す場合：

```bash
# 1. サービス停止
sudo systemctl stop pol-lab

# 2. DBファイル削除
rm config/settings.db

# 3. サービス起動（YAMLから再初期化される）
sudo systemctl start pol-lab
```

### 8.3 部分リセット

特定カテゴリのみリセットする場合は、Web UI設定画面から「初期値に戻す」ボタンを使用（将来実装予定）。

---

## 9. 複数端末展開

### 9.1 新規端末への展開手順

```
1. マスター端末から config.yaml, apps.yaml をコピー
   ↓
2. 必要に応じて初期パスワードを変更
   ↓
3. 新規端末にファイルを配置
   ↓
4. 環境変数を設定（/etc/pol-lab/env）
   - POL_GITHUB_TOKEN を設定
   ↓
5. サービス起動（settings.db が自動生成）
```

※ 環境変数ファイル（/etc/pol-lab/env）は機密情報を含むため、端末ごとに個別に設定する

### 9.2 設定の同期

| 方式 | 内容 |
|------|------|
| 手動 | 各端末のWeb UIから個別設定 |
| 一括 | config.yaml を更新し、各端末の settings.db を削除して再起動 |

---

## 10. バリデーション

### 10.1 起動時バリデーション

| 項目 | チェック内容 |
|------|-------------|
| ポート番号 | 1024〜65535の範囲 |
| ユーザー名 | 3〜32文字、英数字とアンダースコアのみ |
| パスワード | 4文字以上 |
| 権限 | admin または user |
| 初期ユーザー | admin権限のユーザーが最低1人必要 |
| セッション有効時間 | 1〜168時間（1週間） |
| 警告閾値 | 1〜100% |
| ディスクパス | 存在するパス |
| ログレベル | DEBUG/INFO/WARNING/ERRORのいずれか |
| POL_GITHUB_TOKEN | 環境変数が設定されている |
| GitHubリポジトリ | owner/repo 形式で有効な値 |
| インストール先 | 書き込み可能なディレクトリ |

### 10.2 バリデーションエラー時の動作

- エラー内容をログに出力
- デフォルト値で起動を継続（致命的でない場合）
- 致命的エラーの場合は起動停止し、エラーメッセージを表示

---

## 11. 改訂履歴

| 日付 | 版 | 内容 |
|------|-----|------|
| 2025-01-20 | 1.0 | 初版作成 |
| 2025-01-20 | 1.1 | ユーザー管理・権限モデルを追加 |
| 2025-01-20 | 1.2 | GitHub Releases対応、アプリインストール機能を追加 |
| 2025-01-20 | 1.3 | GitHub tokenを環境変数管理に変更 |

# pol-lab 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名
- **リポジトリ名**: pol-lab
- **正式名称**: POL統合ポータル・リソース管理システム

### 1.2 目的
POLシステム群（ラベル印刷指示、ファイル転送、ファイル送受信、ME連携）を統合管理するポータルシステムを提供する。

### 1.3 システム概要
IoT端末上で動作する軽量なWebポータルとして、各アプリケーションへのアクセス、端末リソースの監視、アプリケーションのライフサイクル管理機能を提供する。

---

## 2. システム要件

### 2.1 動作環境
| 項目 | 要件 |
|------|------|
| 動作環境 | IoT端末（Raspberry Pi等） |
| OS | Linux（Raspberry Pi OS / Ubuntu） |
| ネットワーク | ローカルネットワーク限定 |
| Python | 3.9以上 |

### 2.2 非機能要件
| 項目 | 要件 |
|------|------|
| 軽量性 | IoT端末のリソース制約を考慮し、メモリ・CPU使用量を最小化 |
| セキュリティ | ローカルネットワーク内での運用を前提とした適切な認証 |
| 可用性 | 端末起動時に自動起動、障害時の自動復旧 |
| 保守性 | シンプルな構成で保守・更新が容易 |

---

## 3. 機能要件

### 3.1 機能一覧
| No | 機能 | 概要 | 優先度 |
|----|------|------|--------|
| F-01 | ダッシュボード | システム全体の状態を一覧表示 | 必須 |
| F-02 | リソースモニタ | 端末のリソース状況を監視・表示 | 必須 |
| F-03 | アプリケーション管理 | 各アプリの起動・停止・再起動・更新 | 必須 |
| F-04 | ログイン管理 | ユーザー認証・セッション管理 | 必須 |
| F-05 | アプリダウンロード | アプリケーションの取得・更新 | 必須 |

### 3.2 機能詳細

#### F-01: ダッシュボード
| 項目 | 内容 |
|------|------|
| 概要 | 各アプリの状態とリソース状況を一画面で確認 |
| 表示項目 | 各アプリの稼働状態、管理画面へのリンク、リソース概要 |
| 更新方式 | 画面表示時に取得（必要に応じて手動リフレッシュ） |

#### F-02: リソースモニタ
| 項目 | 内容 |
|------|------|
| 概要 | ポータルが動作する端末のリソースを監視 |
| 監視項目 | CPU使用率、メモリ使用率、ディスク使用率、システム稼働時間 |
| 更新間隔 | 手動更新（軽量化のためポーリングは行わない） |
| 表示形式 | 数値 + プログレスバー |

#### F-03: アプリケーション管理
| 項目 | 内容 |
|------|------|
| 概要 | 管理対象アプリのライフサイクル管理 |
| 管理操作 | 起動、停止、再起動、ステータス確認 |
| 管理方式 | systemctl または subprocess による制御 |
| 状態表示 | 実行中 / 停止中 / エラー |

**管理対象アプリケーション:**
| No | アプリ名 | 説明 |
|----|----------|------|
| 1 | ラベル印刷指示アプリ | 医療ラベルの印刷指示を管理 |
| 2 | ファイル転送アプリ | ファイルの転送処理を管理 |
| 3 | ファイル送受信アプリ | ファイルの送受信を管理 |
| 4 | ME連携アプリ | MEシステムとの連携を管理 |

#### F-04: ログイン管理
| 項目 | 内容 |
|------|------|
| 認証方式 | ユーザー名 + パスワード |
| セッション管理 | サーバーサイドセッション（Flask-Session） |
| セッション有効期限 | 24時間（設定可能） |
| パスワード保存 | bcryptによるハッシュ化 |

#### F-05: アプリダウンロード
| 項目 | 内容 |
|------|------|
| 概要 | アプリケーションの取得・更新機能 |
| 取得元 | 設定ファイルで指定（ローカルサーバー/共有フォルダ） |
| 更新方式 | 手動トリガー |

---

## 4. 画面一覧

| No | 画面名 | URL | 概要 |
|----|--------|-----|------|
| S-01 | ログイン画面 | `/login` | ユーザー認証 |
| S-02 | ダッシュボード | `/` | メイン画面、全体状況表示 |
| S-03 | リソースモニタ | `/resources` | 詳細リソース表示 |
| S-04 | アプリ管理 | `/apps` | アプリ一覧・操作 |
| S-05 | アプリ詳細 | `/apps/<app_id>` | 個別アプリの詳細・操作 |
| S-06 | 設定画面 | `/settings` | システム設定 |

---

## 5. 技術構成

### 5.1 技術スタック
| 要素 | 選定 | 選定理由 |
|------|------|----------|
| Backend | Flask | 軽量、シンプル、IoT端末に適合 |
| Frontend | Jinja2 + Vanilla JS | フレームワーク不要で軽量 |
| CSS | Pico.css | クラスレス軽量CSS（約10KB） |
| 認証 | Flask-Login | シンプルなセッション管理 |
| リソース監視 | psutil | 標準的で軽量 |
| プロセス管理 | subprocess / systemctl | OS標準機能活用 |
| パッケージ管理 | uv | 高速な依存関係解決 |

### 5.2 ディレクトリ構成（予定）
```
pol-lab/
├── app/
│   ├── __init__.py          # Flaskアプリ初期化
│   ├── routes/              # ルート定義
│   │   ├── auth.py          # 認証関連
│   │   ├── dashboard.py     # ダッシュボード
│   │   ├── resources.py     # リソースモニタ
│   │   └── apps.py          # アプリ管理
│   ├── services/            # ビジネスロジック
│   │   ├── resource_monitor.py
│   │   └── app_manager.py
│   ├── templates/           # HTMLテンプレート
│   └── static/              # 静的ファイル
├── config/
│   ├── config.yaml          # アプリ設定
│   └── apps.yaml            # 管理対象アプリ定義
├── docs/
│   └── requirements.md      # 本ドキュメント
├── tests/
├── pyproject.toml
└── README.md
```

---

## 6. 設定ファイル仕様

### 6.1 アプリケーション定義（apps.yaml）
```yaml
applications:
  - id: label-printer
    name: ラベル印刷指示アプリ
    description: 医療ラベルの印刷指示を管理
    service_name: pol-label-printer  # systemdサービス名
    web_url: http://localhost:8001   # 管理画面URL
    port: 8001

  - id: file-transfer
    name: ファイル転送アプリ
    description: ファイルの転送処理を管理
    service_name: pol-file-transfer
    web_url: http://localhost:8002
    port: 8002

  - id: file-sync
    name: ファイル送受信アプリ
    description: ファイルの送受信を管理
    service_name: pol-file-sync
    web_url: http://localhost:8003
    port: 8003

  - id: me-integration
    name: ME連携アプリ
    description: MEシステムとの連携を管理
    service_name: pol-me-integration
    web_url: http://localhost:8004
    port: 8004
```

### 6.2 システム設定（config.yaml）
```yaml
server:
  host: 0.0.0.0
  port: 8000
  debug: false

session:
  secret_key: "your-secret-key-here"
  lifetime_hours: 24

auth:
  default_username: admin
  # パスワードはbcryptハッシュで保存

resource_monitor:
  disk_path: "/"  # 監視対象ディスクパス
```

---

## 7. セキュリティ要件

| 項目 | 対策 |
|------|------|
| 認証 | ユーザー名/パスワード認証必須 |
| パスワード保存 | bcryptによるハッシュ化 |
| セッション | サーバーサイド管理、有効期限設定 |
| ネットワーク | ローカルネットワーク限定運用 |
| CSRF対策 | Flask-WTFによるトークン検証 |

---

## 8. 今後の拡張予定（将来検討）

| 項目 | 概要 | 優先度 |
|------|------|--------|
| ログ表示 | 各アプリのログをポータルで確認 | 低 |
| アラート機能 | リソース閾値超過時の通知 | 低 |
| 複数端末管理 | 他端末のリソース監視 | 低 |

---

## 9. 改訂履歴

| 日付 | 版 | 内容 |
|------|-----|------|
| 2025-01-20 | 1.0 | 初版作成 |

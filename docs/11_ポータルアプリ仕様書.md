# ポータルアプリ仕様書

POL Sync のインストール・ログイン管理を行うポータルアプリケーションの仕様書

**バージョン**: 0.1.0（ドラフト）
**最終更新**: 2026-02-05
**文書種別**: ポータルアプリ仕様書
**ステータス**: 設計段階

---

## 目次

- [1. 概要](#1-概要)
- [2. システム構成](#2-システム構成)
- [3. ログイン管理](#3-ログイン管理)
- [4. 自動構築機能](#4-自動構築機能)
- [5. GUI仕様](#5-gui仕様)
- [6. 配布方式](#6-配布方式)
- [7. 対応プラットフォーム](#7-対応プラットフォーム)
- [8. セキュリティ](#8-セキュリティ)
- [9. 今後の検討事項](#9-今後の検討事項)

---

## 1. 概要

### 1.1 目的

ポータルアプリは、IoT端末などの環境で **POL Sync の自動構築** と **ログイン管理** を担うデスクトップアプリケーションである。

端末にポータルアプリを配置・実行するだけで、GitHub リポジトリから POL Sync を自動的にダウンロード・セットアップし、稼働可能な状態にする。
また、POL Sync Web UI へのアクセス制御をポータルアプリ側で一元管理する。

### 1.2 背景

- POL Sync Web UI は現在 **認証なし（Phase 1）** で運用されている
- IoT端末への展開時、手動セットアップは端末台数に比例してコストが増大する
- ログイン管理とインストールを統合することで、端末管理の一元化を実現する

### 1.3 主要機能

| 機能 | 説明 |
|------|------|
| **ログイン管理** | ユーザー認証・セッション管理・アクセス制御 |
| **自動構築** | GitHub からのダウンロード・環境構築・サービス登録を自動実行 |
| **バージョン管理** | インストール済みバージョンの確認・アップデート検知 |
| **ヘルスチェック** | POL Sync の稼働状態を監視し、異常時に通知 |

### 1.4 技術スタック

| 項目 | 技術 |
|------|------|
| **言語** | Python 3.13+ |
| **GUI** | tkinter（Python 標準ライブラリ） |
| **配布** | PyInstaller による単一バイナリ |
| **配布元** | GitHub Releases |

---

## 2. システム構成

### 2.1 全体構成図

```
┌──────────────────────────────────────────────────────┐
│                    IoT端末                            │
│                                                      │
│  ┌────────────────────────────────────────────────┐  │
│  │          ポータルアプリ（常駐）                  │  │
│  │                                                │  │
│  │  ┌──────────────┐  ┌───────────────────────┐  │  │
│  │  │ ログイン管理  │  │ 自動構築エンジン       │  │  │
│  │  │              │  │                       │  │  │
│  │  │ - 認証       │  │ - ダウンロード         │  │  │
│  │  │ - セッション  │  │ - 環境構築            │  │  │
│  │  │ - アクセス制御│  │ - サービス登録         │  │  │
│  │  └──────┬───────┘  └───────────────────────┘  │  │
│  │         │                                      │  │
│  │         │ 認証済みリクエストのみ転送             │  │
│  │         ▼                                      │  │
│  │  ┌────────────────────────────────────────┐    │  │
│  │  │        POL Sync Web UI (:5100)         │    │  │
│  │  │        （認証なしで動作）                │    │  │
│  │  └────────────────────────────────────────┘    │  │
│  └────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────┘
```

### 2.2 コンポーネント構成

```
pol-s3-sync-portal/
├── portal/
│   ├── __main__.py              # エントリーポイント
│   ├── gui.py                   # tkinter GUI
│   ├── config.py                # ポータル設定（GitHub URL, バージョン等）
│   │
│   ├── auth/                    # ログイン管理
│   │   ├── manager.py           # 認証マネージャー
│   │   ├── session.py           # セッション管理
│   │   └── models.py            # ユーザーモデル
│   │
│   ├── installer/               # 自動構築エンジン
│   │   ├── orchestrator.py      # インストール全体制御
│   │   ├── steps/
│   │   │   ├── check_system.py  # システム要件チェック
│   │   │   ├── download.py      # GitHub Release ダウンロード
│   │   │   ├── extract.py       # アーカイブ展開
│   │   │   ├── setup_env.py     # Python仮想環境 + 依存解決
│   │   │   ├── configure.py     # .env / 設定ファイル生成
│   │   │   ├── register.py      # OS サービス登録
│   │   │   └── verify.py        # ヘルスチェック
│   │   └── platforms/
│   │       ├── linux.py         # Linux固有処理（systemd, apt）
│   │       └── windows.py       # Windows固有処理（タスクスケジューラ）
│   │
│   └── health/                  # ヘルスチェック
│       └── checker.py           # 稼働状態監視
│
├── pyproject.toml
└── README.md
```

---

## 3. ログイン管理

### 3.1 認証方式

ポータルアプリがリバースプロキシとして動作し、POL Sync Web UI へのアクセスを認証付きで制御する。

```
ブラウザ → ポータルアプリ (認証) → POL Sync Web UI (:5100)
            ポート: 5000              localhost のみバインド
```

- POL Sync Web UI は `localhost:5100` にバインドし、外部から直接アクセス不可とする
- ポータルアプリがフロントのポート（例: `5000`）でリクエストを受け付け、認証後に転送する

### 3.2 ユーザー管理

| 項目 | 仕様 |
|------|------|
| **ユーザー保存先** | ローカルSQLiteデータベース |
| **パスワード保存** | bcrypt ハッシュ |
| **初期ユーザー** | 初回起動時にセットアップウィザードで作成 |
| **ユーザー権限** | 管理者（admin）/ 一般ユーザー（user）の2段階（将来拡張） |

### 3.3 セッション管理

| 項目 | 仕様 |
|------|------|
| **セッション方式** | トークンベース（JWT or セッションCookie） |
| **有効期限** | 24時間（設定変更可能） |
| **同時セッション** | 制限なし |
| **ログアウト** | 手動ログアウト + 有効期限切れ |

### 3.4 ログイン画面

```
┌──────────────────────────────────────┐
│                                      │
│          POL Sync ポータル            │
│                                      │
│   ┌──────────────────────────────┐   │
│   │  ユーザー名                   │   │
│   └──────────────────────────────┘   │
│   ┌──────────────────────────────┐   │
│   │  パスワード                   │   │
│   └──────────────────────────────┘   │
│                                      │
│          [ ログイン ]                │
│                                      │
│   ログイン状態を保持する ☐           │
│                                      │
└──────────────────────────────────────┘
```

ログイン成功後、POL Sync Web UI のダッシュボードにリダイレクトする。

---

## 4. 自動構築機能

### 4.1 構築フロー

```
ポータルアプリ起動
  │
  ├─ Step 1: システム要件チェック
  │   ├─ OS判定（Linux / Windows）
  │   ├─ アーキテクチャ確認（ARM / x86_64）
  │   ├─ ディスク空き容量確認（最低 500MB）
  │   └─ ネットワーク接続確認
  │
  ├─ Step 2: GitHub Release からダウンロード
  │   ├─ GitHub Releases API で最新バージョン取得
  │   ├─ リリースアーカイブ (.tar.gz / .zip) ダウンロード
  │   └─ チェックサム検証（SHA256）
  │
  ├─ Step 3: アーカイブ展開
  │   ├─ Linux: /opt/pol_s3_sync/
  │   └─ Windows: C:\pol_s3_sync\ (or 環境変数で指定)
  │
  ├─ Step 4: Python 環境構築
  │   ├─ uv が未導入なら自動インストール
  │   ├─ uv sync で仮想環境 + 依存パッケージ導入
  │   └─ インストール検証（import テスト）
  │
  ├─ Step 5: 設定ファイル生成
  │   ├─ .env ファイル生成（共通デフォルト値）
  │   ├─ ConfigInitializer による初期化
  │   └─ config.ini, credentials.ini 等のテンプレート展開
  │
  ├─ Step 6: OS サービス登録
  │   ├─ Linux: systemd ユニットファイル配置 + 有効化
  │   └─ Windows: タスクスケジューラ登録 or NSSM サービス化
  │
  ├─ Step 7: 起動 + ヘルスチェック
  │   ├─ サービス起動
  │   ├─ http://localhost:5100 へ疎通確認
  │   └─ 最大30秒リトライ
  │
  └─ Step 8: 完了
      └─ Web UI リンク表示 / ブラウザ自動起動
```

### 4.2 ダウンロード方式

| 項目 | 仕様 |
|------|------|
| **取得先** | GitHub Releases API (`api.github.com`) |
| **取得対象** | リリースアーカイブ（ソースコード .tar.gz / .zip） |
| **HTTP クライアント** | `urllib`（外部依存なし） |
| **認証** | 不要（パブリックリポジトリ）/ GitHub Token（プライベートリポジトリ） |
| **チェックサム** | SHA256 をリリースノートまたはアセットとして公開 |

### 4.3 アップデート検知

- 起動時に GitHub Releases API で最新バージョンを確認
- ローカルのインストール済みバージョンと比較
- 新バージョンがある場合、GUI上に通知を表示
- ユーザーの許可を得てからアップデートを実行

---

## 5. GUI仕様

### 5.1 メイン画面（インストール前）

```
┌──────────────────────────────────────────┐
│  POL Sync ポータル              v0.1.0  │
├──────────────────────────────────────────┤
│                                          │
│  POL Sync は未インストールです            │
│                                          │
│  インストール先:                         │
│  ┌──────────────────────────┐ [参照]    │
│  │ /opt/pol_s3_sync         │            │
│  └──────────────────────────┘            │
│                                          │
│  バージョン: v3.1.0 (latest)             │
│                                          │
│         [ インストール開始 ]              │
│                                          │
└──────────────────────────────────────────┘
```

### 5.2 インストール進捗画面

```
┌──────────────────────────────────────────┐
│  POL Sync ポータル - インストール中       │
├──────────────────────────────────────────┤
│                                          │
│  ● システムチェック .............. ✓    │
│  ● ダウンロード ................. ✓    │
│  ● ファイル展開 ................. ✓    │
│  ● 環境構築 ..................... ⟳    │
│  ○ 設定ファイル生成                     │
│  ○ サービス登録                         │
│  ○ 動作確認                             │
│                                          │
│  [========================------] 57%    │
│                                          │
│  ログ:                                   │
│  ┌──────────────────────────────────┐    │
│  │ uv sync を実行中...              │    │
│  │ パッケージインストール中 (23/45) │    │
│  └──────────────────────────────────┘    │
│                                          │
│        [キャンセル]                      │
└──────────────────────────────────────────┘
```

### 5.3 メイン画面（インストール済み）

```
┌──────────────────────────────────────────┐
│  POL Sync ポータル              v0.1.0  │
├──────────────────────────────────────────┤
│                                          │
│  ┌─ POL Sync 状態 ──────────────────┐   │
│  │  バージョン:  v3.1.0              │   │
│  │  ステータス:  ● 稼働中            │   │
│  │  Web UI:     http://localhost:5000│   │
│  │  最終更新:   2026-02-05           │   │
│  └──────────────────────────────────┘   │
│                                          │
│  [ Web UIを開く ]  [ サービス再起動 ]    │
│                                          │
│  [ アップデート確認 ]  [ アンインストール]│
│                                          │
└──────────────────────────────────────────┘
```

### 5.4 システムトレイ（常駐）

インストール完了後、ポータルアプリはシステムトレイに常駐する。

| メニュー項目 | 動作 |
|-------------|------|
| Web UIを開く | ブラウザで Web UI を起動 |
| サービス再起動 | POL Sync サービスを再起動 |
| ログ表示 | ポータルアプリのログウィンドウを表示 |
| 終了 | ポータルアプリを終了（サービスは継続） |

---

## 6. 配布方式

### 6.1 ポータルアプリ自体の配布

ポータルアプリは **PyInstaller で単一実行ファイル** にパッケージ化し、GitHub Releases に添付する。

| プラットフォーム | ファイル名 | 形式 |
|-----------------|-----------|------|
| Linux (x86_64) | `pol-portal-linux-amd64` | ELF バイナリ |
| Linux (ARM64) | `pol-portal-linux-arm64` | ELF バイナリ |
| Windows (x64) | `pol-portal-windows-amd64.exe` | PE 実行ファイル |

### 6.2 IoT端末への導入手順

```bash
# Linux の場合（1行で完了）
curl -L https://github.com/<org>/pol-s3-sync-portal/releases/latest/download/pol-portal-linux-arm64 -o pol-portal && chmod +x pol-portal && ./pol-portal

# Windows の場合
# pol-portal-windows-amd64.exe をダウンロードして実行
```

---

## 7. 対応プラットフォーム

| プラットフォーム | アーキテクチャ | サービス管理 | 備考 |
|-----------------|---------------|-------------|------|
| Linux (Raspberry Pi) | ARM64 | systemd | Raspberry Pi OS (Bookworm以降) |
| Linux (一般) | x86_64 | systemd | Ubuntu 22.04+, Debian 12+ |
| Windows IoT | x86_64 | タスクスケジューラ / NSSM | Windows 10 IoT Enterprise 以降 |

### 7.1 最低システム要件

| 項目 | 要件 |
|------|------|
| **RAM** | 512MB 以上 |
| **ストレージ** | 500MB 以上の空き容量 |
| **ネットワーク** | インターネット接続（初回構築時のみ） |
| **Python** | 不要（uv が自動導入、ポータル自体はバイナリ） |

---

## 8. セキュリティ

### 8.1 通信

| 項目 | 仕様 |
|------|------|
| **GitHub通信** | HTTPS |
| **Web UI アクセス** | ポータルアプリ経由でのみ許可 |
| **POL Sync バインド** | `127.0.0.1:5100`（外部アクセス不可） |
| **ポータルバインド** | `0.0.0.0:5000`（LAN内からアクセス可） |

### 8.2 認証情報の保護

- ユーザーパスワードは bcrypt でハッシュ化して保存
- セッショントークンは暗号論的乱数で生成
- GitHub Token（プライベートリポジトリの場合）は OS のキーストアに保存

### 8.3 ダウンロード検証

- リリースアーカイブのSHA256チェックサムを検証
- HTTPS通信による中間者攻撃の防止

---

## 9. 今後の検討事項

### 9.1 未決定事項

| 項目 | 選択肢 | 決定期限 |
|------|--------|---------|
| **リバースプロキシ方式** | 組み込みHTTPプロキシ / Nginx連携 / Flask middleware | 設計フェーズ |
| **ユーザー管理の同期** | ローカルのみ / 中央管理サーバー連携 | 要件定義フェーズ |
| **ログイン画面の実装** | tkinter GUI内 / Webベースのログイン画面 | 設計フェーズ |
| **Windows サービス管理** | NSSM / タスクスケジューラ / python-service | 実装フェーズ |

### 9.2 将来の拡張

- **中央管理サーバー**: 複数端末のポータルアプリを一元管理するダッシュボード
- **OTA アップデート**: ポータルアプリ自体の自動更新機能
- **LDAP / Active Directory 連携**: 企業の既存認証基盤との統合
- **監査ログ**: ログイン履歴・操作履歴の記録と外部転送
- **多要素認証（MFA）**: TOTP 等による追加認証

---

## 関連ドキュメント

| ドキュメント | 説明 |
|-------------|------|
| [00_システム仕様書.md](./00_システム仕様書.md) | POL Sync 本体のシステム仕様 |
| [04_UI仕様書.md](./04_UI仕様書.md) | Web UI 仕様（現行の認証なし仕様） |
| [02_設定仕様書.md](./02_設定仕様書.md) | 設定ファイル・ConfigInitializer の仕様 |
